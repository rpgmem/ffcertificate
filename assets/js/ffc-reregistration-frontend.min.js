!function(e){"use strict";var a=window.ffcReregistration&&window.ffcReregistration.strings||{};function t(t){var r=t.closest(".ffc-rereg-field"),i=r.find(".ffc-field-error"),n=e.trim(t.val()),o="";if(t.prop("required")&&!n&&(o=a.required||"Este campo é obrigatório."),!o&&n){var f=r.data("format")||t.data("format");if("cpf"===f)(function(e){if(11!==(e=e.replace(/\D/g,"")).length)return!1;if(/^(\d)\1{10}$/.test(e))return!1;for(var a=9;a<11;a++){for(var t=0,r=0;r<a;r++)t+=parseInt(e.charAt(r),10)*(a+1-r);if(t=10*t%11%10,parseInt(e.charAt(a),10)!==t)return!1}return!0})(n)||(o=a.invalidCpf||"CPF inválido.");else if("email"===f)/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)||(o=a.invalidEmail||"E-mail inválido.");else if("phone"===f)/^\(?\d{2}\)?\s?\d{4,5}-?\d{4}$/.test(n.replace(/\s+/g,""))||(o=a.invalidPhone||"Telefone inválido.");else if("custom_regex"===f){var s=r.data("regex");if(s)try{new RegExp(s).test(n)||(o=r.data("regex-msg")||a.invalidFormat||"Formato inválido.")}catch(e){}}}return r.toggleClass("has-error",!!o),i.text(o),!o}function r(a){var t={};return a.find('[name^="standard_fields["]').each(function(){var a=this.name.match(/\[(\w+)\]/)[1];t[a]=e(this).val()}),t}function i(a){var t={};return a.find('[name^="custom_fields["]').each(function(){var a=this.name.match(/\[(field_\d+)\]/)[1];"checkbox"===this.type?t[a]=this.checked?"1":"":t[a]=e(this).val()}),t}e(function(){e(document).on("click",".ffc-rereg-open-form",function(){var n,o,f=e(this).data("reregistration-id");n=f,(o=e("#ffc-rereg-form-panel")).html('<div class="ffc-loading">'+(a.loading||"Carregando formulário...")+"</div>").show(),e("html, body").animate({scrollTop:o.offset().top-40},300),e.post(ffcReregistration.ajaxUrl,{action:"ffc_get_reregistration_form",nonce:ffcReregistration.nonce,reregistration_id:n},function(n){var f;n.success?(o.html(n.data.html),function(e){e.find('[data-mask="cpf"]').on("input",function(){var e=this.value.replace(/\D/g,"").substring(0,11);e.length>9?e=e.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/,"$1.$2.$3-$4"):e.length>6?e=e.replace(/(\d{3})(\d{3})(\d{1,3})/,"$1.$2.$3"):e.length>3&&(e=e.replace(/(\d{3})(\d{1,3})/,"$1.$2")),this.value=e}),e.find('[data-mask="phone"]').on("input",function(){var e=this.value.replace(/\D/g,"").substring(0,11);e.length>6?e=e.replace(/(\d{2})(\d{4,5})(\d{4})/,"($1) $2-$3"):e.length>2&&(e=e.replace(/(\d{2})(\d{1,5})/,"($1) $2")),this.value=e}),e.find('[data-mask="cep"]').on("input",function(){var e=this.value.replace(/\D/g,"").substring(0,8);e.length>5&&(e=e.replace(/(\d{5})(\d{1,3})/,"$1-$2")),this.value=e})}(f=o),function(a){a.on("blur","input, textarea, select",function(){t(e(this))})}(f),function(t){var r,i=t.find("#ffc-divisao-setor-map");if(i.length){try{r=JSON.parse(i.text())}catch(e){return}var n=t.find("#ffc_rereg_divisao"),o=t.find("#ffc_rereg_setor");n.on("change",function(){var t=e(this).val(),i=o.val();o.empty(),t&&r[t]?(o.append('<option value="">'+(a.selectSetor||"Selecione")+"</option>"),e.each(r[t],function(e,a){var t=a===i?" selected":"";o.append('<option value="'+a+'"'+t+">"+a+"</option>")})):o.append('<option value="">'+(a.selectDivisao||"Selecione Divisão / Local")+"</option>")})}}(f),function(a){var t=a.find("#ffc_rereg_acumulo"),r=a.find(".ffc-rereg-acumulo-fields");t.on("change",function(){"Sim"===e(this).val()?r.slideDown(200):r.slideUp(200)})}(f),function(t){t.find(".ffc-dependent-select").each(function(){var r,i=e(this),n=i.data("target"),o=t.find("#"+n),f=i.find(".ffc-dep-parent"),s=i.find(".ffc-dep-child"),c=i.find(".ffc-dep-groups");try{r=JSON.parse(c.text())}catch(e){return}function d(){o.val(JSON.stringify({parent:f.val()||"",child:s.val()||""}))}f.on("change",function(){var t=e(this).val();s.empty().append('<option value="">'+(a.select||"Selecione")+"</option>"),t&&r[t]&&e.each(r[t],function(e,a){s.append('<option value="'+a+'">'+a+"</option>")}),d()}),s.on("change",d)})}(f),function(t){t.on("click",".ffc-rereg-draft-btn",function(){var n=e(this),o=t.find(".ffc-rereg-status"),f=t.find('[name="reregistration_id"]').val();n.prop("disabled",!0).text(a.saving||"Salvando..."),o.text(""),e.post(ffcReregistration.ajaxUrl,{action:"ffc_save_reregistration_draft",nonce:ffcReregistration.nonce,reregistration_id:f,standard_fields:r(t),custom_fields:i(t)},function(e){n.prop("disabled",!1).text(a.saveDraft||"Salvar Rascunho"),e.success?(o.text(a.draftSaved||"Rascunho salvo.").addClass("ffc-status-ok"),setTimeout(function(){o.text("").removeClass("ffc-status-ok")},3e3)):o.text(e.data&&e.data.message?e.data.message:a.errorSaving||"Erro ao salvar rascunho.").addClass("ffc-status-err")}).fail(function(){n.prop("disabled",!1).text(a.saveDraft||"Salvar Rascunho"),o.text(a.errorSaving||"Erro ao salvar rascunho.").addClass("ffc-status-err")})})}(f),function(n){n.on("submit","#ffc-rereg-form",function(o){o.preventDefault();var f=!0;if(n.find("input[required]:visible, textarea[required]:visible, select[required]:visible").each(function(){t(e(this))||(f=!1)}),n.find("[data-format]:visible").each(function(){var a=e(this).find("input, textarea, select");a.length||(a=e(this)),a.val()&&(t(a)||(f=!1))}),f){var s=n.find(".ffc-rereg-submit-btn"),c=n.find(".ffc-rereg-status"),d=n.find('[name="reregistration_id"]').val();s.prop("disabled",!0).text(a.submitting||"Enviando..."),c.text("").removeClass("ffc-status-err ffc-status-ok"),e.post(ffcReregistration.ajaxUrl,{action:"ffc_submit_reregistration",nonce:ffcReregistration.nonce,reregistration_id:d,standard_fields:r(n),custom_fields:i(n)},function(t){t.success?(n.find("#ffc-rereg-form").replaceWith('<div class="ffc-dashboard-notice ffc-notice-info"><p>'+(t.data.message||a.submitted||"Recadastramento enviado com sucesso!")+"</p></div>"),e('.ffc-rereg-banner[data-reregistration-id="'+d+'"]').slideUp()):(s.prop("disabled",!1).text(a.submit||"Enviar"),t.data&&t.data.errors&&function(a,t){a.find(".has-error").removeClass("has-error"),a.find(".ffc-field-error").text(""),e.each(t,function(e,t){var r=a.find('[name="'+e+'"]').closest(".ffc-rereg-field");r.addClass("has-error"),r.find(".ffc-field-error").text(t)});var r=a.find(".has-error:first");r.length&&e("html, body").animate({scrollTop:r.offset().top-60},300)}(n,t.data.errors),c.text(t.data&&t.data.message?t.data.message:a.errorSubmitting||"Erro ao enviar.").addClass("ffc-status-err"))}).fail(function(){s.prop("disabled",!1).text(a.submit||"Enviar"),c.text(a.errorSubmitting||"Erro ao enviar.").addClass("ffc-status-err")})}else{n.find(".ffc-rereg-status").text(a.fixErrors||"Por favor, corrija os erros abaixo.").addClass("ffc-status-err");var l=n.find(".has-error:first");l.length&&e("html, body").animate({scrollTop:l.offset().top-60},300)}})}(f),function(a){a.on("click",".ffc-rereg-cancel-btn",function(){e("#ffc-rereg-form-panel").slideUp(200,function(){e(this).empty()})})}(f)):o.html('<div class="ffc-error">'+(n.data&&n.data.message?n.data.message:a.errorLoading||"Erro ao carregar formulário.")+"</div>")}).fail(function(){o.html('<div class="ffc-error">'+(a.errorLoading||"Erro ao carregar formulário.")+"</div>")})}),e(document).on("click",".ffc-rereg-ficha-btn",function(){var t=e(this),r=t.data("submission-id"),i=t.text();r&&(t.prop("disabled",!0).text(a.generatingPdf||"Gerando PDF..."),e.post(ffcReregistration.ajaxUrl,{action:"ffc_download_ficha",nonce:ffcReregistration.nonce,submission_id:r},function(e){t.prop("disabled",!1).text(a.downloadFicha||i),e.success&&e.data.pdf_data?"function"==typeof window.ffcGeneratePDF?window.ffcGeneratePDF(e.data.pdf_data,e.data.pdf_data.filename||"ficha.pdf"):alert(a.errorFicha||"Gerador de PDF não disponível."):alert(e.data&&e.data.message?e.data.message:a.errorFicha||"Erro ao gerar ficha.")}).fail(function(){t.prop("disabled",!1).text(a.downloadFicha||i),alert(a.errorFicha||"Erro ao gerar ficha.")}))})})}(jQuery);