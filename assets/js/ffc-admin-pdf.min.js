!function(e,t){"use strict";function i(t,i){var a="/wp-content/plugins/ffcertificate/html/"+t,o=window.FFC.Admin.showNotification||function(){},n="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{},r=n.loadingTemplate||"Loading template...";o(r,"info",0),fetch(a).then(function(e){if(!e.ok)throw new Error("HTTP error! status: "+e.status);return e.text()}).then(function(a){var r=e("#ffc_pdf_layout");if(r.length){r.val(a),r.trigger("change");var l=(n.templateLoadedSuccess||'Template "%s" loaded successfully!').replace("%s",i||t);o("✓ "+l,"success",3e3)}else{var f=n.htmlFieldNotFound||"HTML field not found.";o("✗ "+f,"error")}}).catch(function(e){var t="";if(e.message.includes("404"))t=n.templateFileNotFound||"Template file not found. Check if file exists in html/ folder.";else if(e.message.includes("403"))t=n.accessDenied||"Access denied. Check file permissions.";else if(e.message.includes("Failed to fetch"))t=n.networkError||"Network error. Check your connection.";else{t=(n.errorLoadingTemplate||"Error loading template: %s").replace("%s",e.message)}o("✗ "+t,"error",8e3)})}e(document).on("click","#ffc_load_template_btn",function(t){t.preventDefault();var a="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{},o=a.selectTemplate||"Select a Template",n=a.cancel||"Cancel",r='<div id="ffc-template-modal" role="dialog" aria-modal="true" aria-labelledby="ffc-template-modal-title" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:999999;display:flex;align-items:center;justify-content:center;">';r+='<div style="background:#fff;padding:30px;border-radius:8px;max-width:500px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">',r+='<h2 id="ffc-template-modal-title" style="margin:0 0 20px 0;font-size:20px;">'+o+"</h2>",r+='<div style="max-height:400px;overflow-y:auto;">',[{value:"atestado_estagios.html",label:"Atestado de Estágios"},{value:"certificado_1.html",label:"Certificado Modelo 1"},{value:"certificado_2.html",label:"Certificado Modelo 2"},{value:"declaracao.html",label:"Declaração"}].forEach(function(e){r+='<div class="ffc-template-option" data-file="'+e.value+'" style="padding:15px;margin:10px 0;border:2px solid #ddd;border-radius:4px;cursor:pointer;transition:all 0.2s;">',r+='<strong style="font-size:16px;">'+e.label+"</strong>",r+='<div style="color:#666;font-size:13px;margin-top:5px;">'+e.value+"</div>",r+="</div>"}),r+="</div>",r+='<div style="margin-top:20px;text-align:right;">',r+='<button id="ffc-modal-cancel" class="button" style="margin-right:10px;">'+n+"</button>",r+="</div>",r+="</div></div>",e("body").append(r),e(".ffc-template-option").hover(function(){e(this).css({"border-color":"#2271b1",background:"#f0f6fc"})},function(){e(this).css({"border-color":"#ddd",background:"transparent"})}),e("#ffc-modal-cancel").on("click",function(){e("#ffc-template-modal").fadeOut(200,function(){e(this).remove()})}),e("#ffc-template-modal").on("click",function(t){"ffc-template-modal"===t.target.id&&e(this).fadeOut(200,function(){e(this).remove()})}),e(document).on("keydown.ffcTemplateModal",function(t){"Escape"===t.key&&e("#ffc-template-modal").length&&(e("#ffc-template-modal").fadeOut(200,function(){e(this).remove()}),e(document).off("keydown.ffcTemplateModal"))}),e(".ffc-template-option").on("click",function(){var t=e(this).data("file"),a=e(this).find("strong").text();e("#ffc-template-modal").remove();var o="undefined"!=typeof ffc_ajax&&ffc_ajax.strings&&ffc_ajax.strings.confirmLoadTemplate?ffc_ajax.strings.confirmLoadTemplate.replace("%s",a):'Load "'+a+'"? This will replace your current certificate HTML.';confirm(o)&&i(t,a)})}),e(document).on("click","#ffc_btn_import_html",function(t){t.preventDefault();var i=window.FFC.Admin.showNotification||function(){},a=e("#ffc_import_html_file");if(a.length||(a=e('input[type="file"][name*="import"]')),a.length)a.click();else{var o=e('<input type="file" accept=".html" style="display:none">');e("body").append(o),o.on("change",function(t){var a=t.target.files[0];if(a){var n="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{};if("text/html"===a.type||a.name.endsWith(".html")){var r=new FileReader;r.onload=function(t){var a=e("#ffc_pdf_layout");if(a.length){a.val(t.target.result);var r=n.htmlImportedSuccess||"HTML imported successfully!";i(r,"success")}else{var l=n.htmlFieldNotFound||"HTML field not found.";i("Error: "+l,"error")}o.remove()},r.readAsText(a)}else{var l=n.selectHtmlFile||"Please select an HTML file.";i(l,"warning")}}}),o.click()}}),e(document).on("change",'#ffc_import_html_file, input[type="file"][name*="import"]',function(t){var i=t.target.files[0];if(i){var a=window.FFC.Admin.showNotification||function(){},o="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{},n=new FileReader;n.onload=function(t){var i=e("#ffc_pdf_layout");if(i.length){i.val(t.target.result);var n=o.htmlImportedSuccess||"HTML imported successfully!";a(n,"success")}else{var r=o.htmlTextareaNotFound||"HTML textarea not found";a("Error: "+r,"error")}},n.onerror=function(){var e=o.errorReadingFile||"Error reading file";a(e,"error")},n.readAsText(i),e(this).val("")}});var a,o={name:"John Doe",email:"john_doe@example.com",cpf_rf:"123.456.789-00",cpf:"123.456.789-00",auth_code:"A1B2-C3D4-E5F6",form_title:e("#title").val()||"Certificate Title",submission_date:(new Date).toLocaleDateString("pt-BR",{year:"numeric",month:"long",day:"numeric"}),print_date:(new Date).toLocaleDateString("pt-BR",{year:"numeric",month:"long",day:"numeric"}),fill_date:(new Date).toLocaleDateString("pt-BR",{year:"numeric",month:"long",day:"numeric"}),date:(new Date).toLocaleDateString("pt-BR",{year:"numeric",month:"long",day:"numeric"}),submission_id:"1234",magic_token:"abc123def456ghi789jkl012",ticket:"TK01-AB2C-3D4E"};e(document).on("click","#ffc_btn_preview",function(t){t.preventDefault();var i=e("#ffc_pdf_layout").val(),a="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{};if(i&&i.trim()){var n,r=e("#ffc_bg_image_input, #ffc_bg_image_url").first().val()||"",l=function(e,t){return(e=(e=e.replace(/\{\{(\w+)\}\}/g,function(e,i){return void 0!==t[i]?t[i]:e})).replace(/\{\{qr_code[^}]*\}\}/g,'<svg width="150" height="150" viewBox="0 0 150 150" xmlns="http://www.w3.org/2000/svg"><rect width="150" height="150" fill="#f0f0f0" stroke="#ccc" stroke-width="1"/><text x="75" y="70" text-anchor="middle" font-size="12" fill="#999">QR Code</text><text x="75" y="90" text-anchor="middle" font-size="10" fill="#bbb">(preview)</text></svg>')).replace(/\{\{validation_url[^}]*\}\}/g,'<a href="#" style="color:#0073aa;">https://example.com/valid/#token=abc123</a>')}(i,((n=e.extend({},o)).form_title=e("#title").val()||n.form_title,e("#ffc-fields-container .ffc-field-row").each(function(){var t=e(this).find('input[name*="[name]"]').val(),i=e(this).find('input[name*="[label]"]').val();t&&!n[t]&&(n[t]=i||t)}),n)),f='<!DOCTYPE html><html><head><meta charset="UTF-8">';f+="<style>",f+="html, body { margin: 0; padding: 0; }",f+="body { font-family: Arial, Helvetica, sans-serif; ",r&&(f+="background-image: url("+r+"); ",f+="background-size: cover; background-position: center; background-repeat: no-repeat; "),f+="}",f+="</style></head><body>",f+=l,f+="</body></html>";var c=a.previewTitle||"Certificate Preview",d=a.close||"Close",s=a.previewSampleNote||"Placeholders replaced with sample data. QR code shown as placeholder.",m=e('<div id="ffc-preview-modal"><div class="ffc-preview-backdrop"></div><div class="ffc-preview-container"><div class="ffc-preview-header"><h2>'+c+'</h2><button type="button" class="ffc-preview-close" title="'+d+'">&times;</button></div><div class="ffc-preview-note">'+s+'</div><div class="ffc-preview-body"><iframe id="ffc-preview-iframe" frameborder="0"></iframe></div></div></div>');e("body").append(m);var p=document.getElementById("ffc-preview-iframe"),u=p.contentWindow||p.contentDocument;u.document&&(u=u.document),u.open(),u.write(f),u.close(),requestAnimationFrame(function(){m.addClass("ffc-preview-visible")}),m.find(".ffc-preview-close").on("click",g),m.find(".ffc-preview-backdrop").on("click",g),e(document).on("keydown.ffcPreview",function(t){"Escape"===t.key&&(g(),e(document).off("keydown.ffcPreview"))})}else{var v=a.previewEmpty||"The HTML editor is empty. Add a template first.";alert(v)}function g(){m.removeClass("ffc-preview-visible"),setTimeout(function(){m.remove()},200)}}),e(document).on("click","#ffc_btn_media_lib",function(t){t.preventDefault();var i=window.FFC.Admin.showNotification||function(){},o="undefined"!=typeof ffc_ajax&&ffc_ajax.strings?ffc_ajax.strings:{};if("undefined"!=typeof wp&&void 0!==wp.media)if(a)a.open();else{var n=o.chooseBackgroundImage||"Choose Background Image",r=o.useThisImage||"Use this image";(a=wp.media({title:n,button:{text:r},multiple:!1})).on("select",function(){var t=a.state().get("selection").first().toJSON(),n=e("#ffc_bg_image_url");n.length||(n=e('input[name*="bg_image"], input[name*="background"]').first()),n.length&&n.val(t.url);var r=e("#ffc_bg_image_preview");r.length&&r.html("").append(e("<img>").attr("src",t.url).css({"max-width":"200px",height:"auto"}));var l=o.backgroundImageSelected||"Background image selected!";i(l,"success")}),a.open()}else{var l=o.wpMediaNotAvailable||"WordPress Media Library is not available. Please reload the page.";i(l,"error")}}),window.FFC=window.FFC||{},window.FFC.Admin=window.FFC.Admin||{},window.FFC.Admin.PDF={loadTemplate:i},t.registerModule&&t.registerModule("Admin.PDF",t.version)}(jQuery,window.FFC);