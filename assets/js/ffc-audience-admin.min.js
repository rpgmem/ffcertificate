!function(e){"use strict";function t(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}const n={init:function(){this.bindEvents()},bindEvents:function(){e(document).on("change",'.ffc-day-row input[type="checkbox"]',function(){e(this).closest(".ffc-day-row").find('input[type="time"]').prop("disabled",e(this).is(":checked"))}),this.initUserSearch(),this.initEnvironmentFilter(),this.initBookingActions(),this.initCalendarPermissions()},initUserSearch:function(){var n=e("#user_search");if(n.length){var i,a={},s="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.searchUsersNonce:"";n.on("input",function(){clearTimeout(i);var n=e(this).val();n.length<2?e("#user_results").removeClass("active").empty():i=setTimeout(function(){e.ajax({url:ajaxurl,type:"POST",data:{action:"ffc_search_users",query:n,nonce:s},success:function(n){if(n.success&&n.data.length>0){var i="";n.data.forEach(function(e){a[e.id]||(i+='<div class="ffc-user-result" data-id="'+e.id+'" data-name="'+t(e.name)+'">'+t(e.name)+" ("+t(e.email)+")</div>")}),e("#user_results").html(i).addClass("active")}else e("#user_results").removeClass("active").empty()}})},300)}),e(document).on("click",".ffc-user-result",function(){var t=e(this).data("id"),i=e(this).data("name");a[t]=i,c(),e("#user_results").removeClass("active").empty(),n.val("")}),e(document).on("click",".ffc-selected-user .remove",function(){var t=e(this).data("id");delete a[t],c()})}function c(){var n="",i=[];for(var s in a)n+='<span class="ffc-selected-user">'+t(a[s])+'<span class="remove" data-id="'+s+'">&times;</span></span>',i.push(s);e("#selected_users").html(n),e("#selected_user_ids").val(i.join(","))}},initEnvironmentFilter:function(){var t=e("#filter-schedule"),n=e("#filter-environment");if(t.length&&n.length){var i="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.strings:{},a="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.adminNonce:"",s=i.allEnvironments||"All Environments",c=i.loading||"Loading...";t.on("change",function(){var t=e(this).val();t?(n.html('<option value="">'+c+"</option>"),e.ajax({url:ajaxurl,type:"POST",data:{action:"ffc_audience_get_environments",schedule_id:t,nonce:a},success:function(t){if(t.success&&t.data){var i='<option value="">'+s+"</option>";e.each(t.data,function(t,n){i+='<option value="'+n.id+'">'+e("<div/>").text(n.name).html()+"</option>"}),n.html(i)}else n.html('<option value="">'+s+"</option>")},error:function(){n.html('<option value="">'+s+"</option>")}})):n.html('<option value="">'+s+"</option>")})}},initBookingActions:function(){if(e(".ffc-view-booking").length||e(".ffc-cancel-booking").length){var t="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.strings:{},n="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.adminNonce:"";e(document).on("click",".ffc-view-booking",function(a){a.preventDefault();var s=e(this).data("booking-id");e("#ffc-booking-modal").remove();var c=e('<div id="ffc-booking-modal" class="ffc-admin-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="ffc-admin-modal-title"><div class="ffc-admin-modal"><div class="ffc-admin-modal-header"><h3 id="ffc-admin-modal-title">'+i(t.bookingDetails||"Booking Details")+'</h3><button type="button" class="ffc-admin-modal-close" aria-label="Close">&times;</button></div><div class="ffc-admin-modal-body"><p>'+i(t.loading||"Loading...")+"</p></div></div></div>");e("body").append(c),c.show(),c.find(".ffc-admin-modal-close").focus(),e.ajax({url:ajaxurl,type:"POST",data:{action:"ffc_audience_get_booking",booking_id:s,nonce:n},success:function(e){if(e.success){var n=e.data,a=parseInt(n.is_all_day)?t.allDay||"All Day":n.start_time+" - "+n.end_time,s="audience"===n.booking_type?t.audience||"Audience":t.customUsers||"Custom Users",o="active"===n.status?t.active||"Active":t.cancelled||"Cancelled",r="active"===n.status?"status-active":"status-cancelled",d='<table class="widefat fixed"><tbody>';if(d+="<tr><th>"+i(t.date||"Date")+"</th><td>"+i(n.booking_date)+"</td></tr>",d+="<tr><th>"+i(t.time||"Time")+"</th><td>"+i(a)+"</td></tr>",d+="<tr><th>"+i(t.environmentLabel||"Environment")+"</th><td>"+i(n.environment_name)+"</td></tr>",d+="<tr><th>"+i(t.description||"Description")+"</th><td>"+i(n.description)+"</td></tr>",d+="<tr><th>"+i(t.type||"Type")+"</th><td>"+i(s)+"</td></tr>",d+="<tr><th>"+i(t.status||"Status")+'</th><td><span class="'+r+'">'+i(o)+"</span></td></tr>",d+="<tr><th>"+i(t.createdBy||"Created By")+"</th><td>"+i(n.created_by)+"</td></tr>",n.audiences&&n.audiences.length>0){var l=n.audiences.map(function(e){return e.name}).join(", ");d+="<tr><th>"+i(t.audiences||"Audiences")+"</th><td>"+i(l)+"</td></tr>"}if(n.users&&n.users.length>0){var u=n.users.map(function(e){return e.name+" ("+e.email+")"}).join(", ");d+="<tr><th>"+i(t.users||"Users")+"</th><td>"+i(u)+"</td></tr>"}"cancelled"===n.status&&n.cancel_reason&&(d+="<tr><th>"+i(t.cancelReason||"Cancel Reason")+"</th><td>"+i(n.cancel_reason)+"</td></tr>"),d+="</tbody></table>",c.find(".ffc-admin-modal-body").html(d)}else c.find(".ffc-admin-modal-body").html("<p>"+i(e.data.message||t.error)+"</p>")},error:function(){c.find(".ffc-admin-modal-body").html("<p>"+i(t.error||"An error occurred.")+"</p>")}})}),e(document).on("click",".ffc-admin-modal-close, .ffc-admin-modal-overlay",function(t){t.target===this&&e("#ffc-booking-modal").remove()}),e(document).on("keydown",function(t){"Escape"===t.key&&e("#ffc-booking-modal").length&&e("#ffc-booking-modal").remove()}),e(document).on("click",".ffc-cancel-booking",function(i){i.preventDefault();var a=e(this),s=a.data("booking-id");if(confirm(t.confirmCancel||"Are you sure you want to cancel this booking?")){var c=prompt(t.cancelReason||"Please provide a reason for cancellation:");null!==c&&(a.css("pointer-events","none").css("opacity","0.5"),e.ajax({url:ajaxurl,type:"POST",data:{action:"ffc_audience_cancel_booking",booking_id:s,reason:c,nonce:n},success:function(e){e.success?(a.closest("tr").find(".status-active").removeClass("status-active").addClass("status-cancelled").text(t.cancelled||"Cancelled"),a.prev().remove(),a.remove()):(alert(e.data.message||t.error),a.css("pointer-events","").css("opacity",""))},error:function(){alert(t.error||"An error occurred."),a.css("pointer-events","").css("opacity","")}}))}})}function i(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e||"")),t.innerHTML}},initCalendarPermissions:function(){var n=e("#ffc-permissions-table");if(n.length){var i=n.data("schedule-id");if(i){var a="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin:{},s=a.schedulePermissionsNonce||"",c=a.searchUsersNonce||"",o=a.strings||{},r=null,d=0;e("#ffc-user-search").on("input",function(){clearTimeout(r);var i=e(this).val().trim();i.length<2?e("#ffc-user-search-results").hide():r=setTimeout(function(){e.get(ajaxurl,{action:"ffc_search_users",query:i,nonce:c},function(i){if(i.success&&i.data.length>0){var a="",s=[];n.find("tbody tr[data-user-id]").each(function(){s.push(parseInt(e(this).data("user-id")))}),e.each(i.data,function(e,n){var i=-1!==s.indexOf(n.id);a+='<div class="ffc-user-result'+(i?" ffc-user-exists":"")+'" data-id="'+n.id+'" data-name="'+t(n.name)+'" style="padding: 8px 12px; cursor: '+(i?"default":"pointer")+"; border-bottom: 1px solid #eee;"+(i?" opacity: 0.5;":"")+'">',a+="<strong>"+t(n.name)+"</strong>",a+="<br><small>"+t(n.email)+"</small>",i&&(a+=" <em>("+t(o.alreadyAdded||"already added")+")</em>"),a+="</div>"}),e("#ffc-user-search-results").html(a).show()}else e("#ffc-user-search-results").html('<div style="padding: 8px 12px; color: #666;"><em>'+t(o.noUsersFound||"No users found.")+"</em></div>").show()})},300)}),e(document).on("click","#ffc-user-search-results .ffc-user-result:not(.ffc-user-exists)",function(){d=parseInt(e(this).data("id")),e("#ffc-user-search").val(e(this).data("name")),e("#ffc-selected-user-id").val(d),e("#ffc-add-user-btn").prop("disabled",!1),e("#ffc-user-search-results").hide()}),e(document).on("click",function(t){e(t.target).closest("#ffc-user-search, #ffc-user-search-results").length||e("#ffc-user-search-results").hide()}),e("#ffc-add-user-btn").on("click",function(){if(d){var t=e(this);t.prop("disabled",!0),e.post(ajaxurl,{action:"ffc_audience_add_user_permission",schedule_id:i,user_id:d,_wpnonce:s},function(i){i.success?(e("#ffc-no-permissions-row").remove(),n.find("tbody").append(i.data.html),e("#ffc-user-search").val(""),d=0,e("#ffc-selected-user-id").val("")):(alert(i.data.message||o.errorAddingUser||"Error adding user."),t.prop("disabled",!1))})}}),e(document).on("change",".ffc-perm-toggle",function(){var t=e(this).closest("tr").data("user-id"),n=e(this).data("perm"),a=e(this).is(":checked")?1:0;e.post(ajaxurl,{action:"ffc_audience_update_user_permission",schedule_id:i,user_id:t,permission:n,value:a,_wpnonce:s})}),e(document).on("click",".ffc-remove-user-btn",function(){if(confirm(o.confirmRemoveUser||"Remove this user's access?")){var a=e(this).closest("tr"),c=a.data("user-id");e.post(ajaxurl,{action:"ffc_audience_remove_user_permission",schedule_id:i,user_id:c,_wpnonce:s},function(i){i.success&&a.fadeOut(300,function(){e(this).remove(),0===n.find("tbody tr").length&&n.find("tbody").html('<tr id="ffc-no-permissions-row"><td colspan="5"><em>'+t(o.noUsersYet||"No users have been granted access yet.")+"</em></td></tr>")})})}})}}}};e(document).ready(function(){n.init()})}(jQuery);