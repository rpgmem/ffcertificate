!function(e){"use strict";function t(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}const n={init:function(){this.bindEvents()},bindEvents:function(){e(document).on("change",'.ffc-day-row input[type="checkbox"]',function(){e(this).closest(".ffc-day-row").find('input[type="time"]').prop("disabled",e(this).is(":checked"))}),this.initUserSearch(),this.initEnvironmentFilter(),this.initBookingActions()},initUserSearch:function(){var n=e("#user_search");if(n.length){var a,i={},o="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.searchUsersNonce:"";n.on("input",function(){clearTimeout(a);var n=e(this).val();n.length<2?e("#user_results").removeClass("active").empty():a=setTimeout(function(){e.ajax({url:ajaxurl,type:"POST",data:{action:"ffc_search_users",query:n,nonce:o},success:function(n){if(n.success&&n.data.length>0){var a="";n.data.forEach(function(e){i[e.id]||(a+='<div class="ffc-user-result" data-id="'+e.id+'" data-name="'+t(e.name)+'">'+t(e.name)+" ("+t(e.email)+")</div>")}),e("#user_results").html(a).addClass("active")}else e("#user_results").removeClass("active").empty()}})},300)}),e(document).on("click",".ffc-user-result",function(){var t=e(this).data("id"),a=e(this).data("name");i[t]=a,c(),e("#user_results").removeClass("active").empty(),n.val("")}),e(document).on("click",".ffc-selected-user .remove",function(){var t=e(this).data("id");delete i[t],c()})}function c(){var n="",a=[];for(var o in i)n+='<span class="ffc-selected-user">'+t(i[o])+'<span class="remove" data-id="'+o+'">&times;</span></span>',a.push(o);e("#selected_users").html(n),e("#selected_user_ids").val(a.join(","))}},initEnvironmentFilter:function(){var t=e("#filter-schedule"),n=e("#filter-environment");if(t.length&&n.length){var a="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.strings:{},i="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.adminNonce:"",o=a.allEnvironments||"All Environments",c=a.loading||"Loading...";t.on("change",function(){var t=e(this).val();t?(n.html('<option value="">'+c+"</option>"),e.ajax({url:ajaxurl,type:"POST",data:{action:"ffc_audience_get_environments",schedule_id:t,nonce:i},success:function(t){if(t.success&&t.data){var a='<option value="">'+o+"</option>";e.each(t.data,function(t,n){a+='<option value="'+n.id+'">'+e("<div/>").text(n.name).html()+"</option>"}),n.html(a)}else n.html('<option value="">'+o+"</option>")},error:function(){n.html('<option value="">'+o+"</option>")}})):n.html('<option value="">'+o+"</option>")})}},initBookingActions:function(){if(e(".ffc-view-booking").length||e(".ffc-cancel-booking").length){var t="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.strings:{},n="undefined"!=typeof ffcAudienceAdmin?ffcAudienceAdmin.adminNonce:"";e(document).on("click",".ffc-view-booking",function(i){i.preventDefault();var o=e(this).data("booking-id");e("#ffc-booking-modal").remove();var c=e('<div id="ffc-booking-modal" class="ffc-admin-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="ffc-admin-modal-title"><div class="ffc-admin-modal"><div class="ffc-admin-modal-header"><h3 id="ffc-admin-modal-title">'+a(t.bookingDetails||"Booking Details")+'</h3><button type="button" class="ffc-admin-modal-close" aria-label="Close">&times;</button></div><div class="ffc-admin-modal-body"><p>'+a(t.loading||"Loading...")+"</p></div></div></div>");e("body").append(c),c.show(),c.find(".ffc-admin-modal-close").focus(),e.ajax({url:ajaxurl,type:"POST",data:{action:"ffc_audience_get_booking",booking_id:o,nonce:n},success:function(e){if(e.success){var n=e.data,i=parseInt(n.is_all_day)?t.allDay||"All Day":n.start_time+" - "+n.end_time,o="audience"===n.booking_type?t.audience||"Audience":t.customUsers||"Custom Users",s="active"===n.status?t.active||"Active":t.cancelled||"Cancelled",d="active"===n.status?"status-active":"status-cancelled",r='<table class="widefat fixed"><tbody>';if(r+="<tr><th>"+a(t.date||"Date")+"</th><td>"+a(n.booking_date)+"</td></tr>",r+="<tr><th>"+a(t.time||"Time")+"</th><td>"+a(i)+"</td></tr>",r+="<tr><th>"+a(t.environmentLabel||"Environment")+"</th><td>"+a(n.environment_name)+"</td></tr>",r+="<tr><th>"+a(t.description||"Description")+"</th><td>"+a(n.description)+"</td></tr>",r+="<tr><th>"+a(t.type||"Type")+"</th><td>"+a(o)+"</td></tr>",r+="<tr><th>"+a(t.status||"Status")+'</th><td><span class="'+d+'">'+a(s)+"</span></td></tr>",r+="<tr><th>"+a(t.createdBy||"Created By")+"</th><td>"+a(n.created_by)+"</td></tr>",n.audiences&&n.audiences.length>0){var l=n.audiences.map(function(e){return e.name}).join(", ");r+="<tr><th>"+a(t.audiences||"Audiences")+"</th><td>"+a(l)+"</td></tr>"}if(n.users&&n.users.length>0){var f=n.users.map(function(e){return e.name+" ("+e.email+")"}).join(", ");r+="<tr><th>"+a(t.users||"Users")+"</th><td>"+a(f)+"</td></tr>"}"cancelled"===n.status&&n.cancel_reason&&(r+="<tr><th>"+a(t.cancelReason||"Cancel Reason")+"</th><td>"+a(n.cancel_reason)+"</td></tr>"),r+="</tbody></table>",c.find(".ffc-admin-modal-body").html(r)}else c.find(".ffc-admin-modal-body").html("<p>"+a(e.data.message||t.error)+"</p>")},error:function(){c.find(".ffc-admin-modal-body").html("<p>"+a(t.error||"An error occurred.")+"</p>")}})}),e(document).on("click",".ffc-admin-modal-close, .ffc-admin-modal-overlay",function(t){t.target===this&&e("#ffc-booking-modal").remove()}),e(document).on("keydown",function(t){"Escape"===t.key&&e("#ffc-booking-modal").length&&e("#ffc-booking-modal").remove()}),e(document).on("click",".ffc-cancel-booking",function(a){a.preventDefault();var i=e(this),o=i.data("booking-id");if(confirm(t.confirmCancel||"Are you sure you want to cancel this booking?")){var c=prompt(t.cancelReason||"Please provide a reason for cancellation:");null!==c&&(i.css("pointer-events","none").css("opacity","0.5"),e.ajax({url:ajaxurl,type:"POST",data:{action:"ffc_audience_cancel_booking",booking_id:o,reason:c,nonce:n},success:function(e){e.success?(i.closest("tr").find(".status-active").removeClass("status-active").addClass("status-cancelled").text(t.cancelled||"Cancelled"),i.prev().remove(),i.remove()):(alert(e.data.message||t.error),i.css("pointer-events","").css("opacity",""))},error:function(){alert(t.error||"An error occurred."),i.css("pointer-events","").css("opacity","")}}))}})}function a(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e||"")),t.innerHTML}}};e(document).ready(function(){n.init()})}(jQuery);