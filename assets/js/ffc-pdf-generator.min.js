!function(e,a){"use strict";function o(){return"undefined"==typeof html2canvas?(console.error("[FFC PDF] html2canvas library not loaded"),!1):void 0!==a.jspdf&&void 0!==a.jspdf.jsPDF||(console.error("[FFC PDF] jsPDF library not loaded"),!1)}function t(){e("#ffc-pdf-overlay").fadeOut(300,function(){e(this).remove()})}function n(n,i){if(console.log("[FFC PDF] Starting PDF generation..."),console.log("[FFC PDF] Template length:",n.html?n.html.length:0),!o()){var r="undefined"!=typeof ffc_ajax&&ffc_ajax.strings&&ffc_ajax.strings.pdfLibrariesFailed?ffc_ajax.strings.pdfLibrariesFailed:"PDF libraries failed to load. Please refresh the page.";return void alert(r)}const{jsPDF:s}=a.jspdf;!function(){if(!(e("#ffc-pdf-overlay").length>0)){var a=e('<div id="ffc-pdf-overlay"></div>').css({position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(0, 0, 0, 0.8)","z-index":"999999",display:"flex","align-items":"center","justify-content":"center"}),o=e("<div></div>").css({background:"white",padding:"40px","border-radius":"8px","text-align":"center","max-width":"400px","box-shadow":"0 4px 20px rgba(0,0,0,0.3)"}),t=e('<div class="ffc-spinner"></div>').css({border:"4px solid #f3f3f3","border-top":"4px solid #2271b1","border-radius":"50%",width:"50px",height:"50px",margin:"0 auto 20px",animation:"ffc-spin 1s linear infinite"}),n="undefined"!=typeof ffc_ajax&&ffc_ajax.strings&&ffc_ajax.strings.generatingPdf?ffc_ajax.strings.generatingPdf:"Generating PDF...",i=e("<h3></h3>").css({margin:"0 0 10px 0",color:"#333","font-size":"18px","font-weight":"600"}).text(n),r="undefined"!=typeof ffc_ajax&&ffc_ajax.strings&&ffc_ajax.strings.pleaseWait?ffc_ajax.strings.pleaseWait:"Please wait, this may take a few seconds...",s=e("<p></p>").css({margin:"0",color:"#666","font-size":"14px","line-height":"1.5"}).text(r);o.append(t).append(i).append(s),a.append(o),e("body").append(a),e("#ffc-spinner-animation").length||e('<style id="ffc-spinner-animation">@keyframes ffc-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>').appendTo("head")}}();var f=Date.now(),l="portrait"===n.orientation,d="ficha"===n.type,c=l?"794px":"1123px",g=l?"1123px":"794px";console.log("[FFC PDF] Orientation:",l?"portrait":"landscape"),console.log("[FFC PDF] Multi-page:",d);var F={position:"fixed",top:"0",left:"0",width:c,overflow:"hidden",background:"white","z-index":"999998",opacity:"0"};d?(F.height="auto",F.overflow="visible"):F.height=g;var p=e('<div class="ffc-pdf-temp-container"></div>').css(F).appendTo("body"),h=n.html||"";console.log("[FFC PDF] HTML preview:",h.substring(0,200));var m='<div class="ffc-pdf-wrapper" style="width:100%;height:'+(d?"auto":"100%")+';position:relative;">';n.bg_image&&(m+='<img src="'+n.bg_image+'" class="ffc-pdf-bg" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;" crossorigin="anonymous">'),m+='<div class="ffc-pdf-content" style="position:relative;z-index:1;">'+h+"</div>",m+="</div>",p.html(m),console.log("[FFC PDF] Container created and visible");var x,v=p.find("img"),u=v.length,P=0;function D(){P++,console.log("[FFC PDF] Image loaded: "+P+"/"+u),P>=u&&(clearTimeout(x),console.log("[FFC PDF] All images loaded! Generating PDF..."),C())}function C(){var a=Date.now()-f,o=Math.max(0,800-a);console.log("[FFC PDF] Elapsed:",a+"ms","Remaining:",o+"ms"),setTimeout(function(){var a=p.find(".ffc-pdf-wrapper")[0];if(!a){console.error("[FFC PDF] Wrapper not found!");var o="undefined"!=typeof ffc_ajax&&ffc_ajax.strings&&ffc_ajax.strings.pdfContainerNotFound?ffc_ajax.strings.pdfContainerNotFound:"Error: PDF container not found";return alert(o),p.remove(),void t()}var n,r=l?794:1123,f=l?1123:794;console.log("[FFC PDF] === PDF Generation Started ==="),d?(e(a).css({width:r+"px","max-width":r+"px",transform:"scale(1)","box-sizing":"border-box"}),n=a.scrollHeight,console.log("[FFC PDF] Content height:",n+"px","("+Math.ceil(n/f)+" pages)")):(e(a).css({width:r+"px",height:f+"px","max-width":r+"px","max-height":f+"px",transform:"scale(1)",overflow:"hidden","box-sizing":"border-box"}),n=f),console.log("[FFC PDF] Target:",r+"x"+n+"px"),setTimeout(function(){console.log("[FFC PDF] Capturing with html2canvas..."),html2canvas(a,{scale:2,width:r,height:n,useCORS:!0,allowTaint:!1,logging:!0,backgroundColor:"#ffffff"}).then(function(e){try{console.log("[FFC PDF] Canvas:",e.width+"x"+e.height+"px");var a=new s(l?"portrait":"landscape","mm","a4"),o=l?210:297,n=l?297:210,r=2*f,d=Math.ceil(e.height/r);console.log("[FFC PDF] Total pages:",d);for(var c=0;c<d;c++){c>0&&a.addPage();var g=document.createElement("canvas");g.width=e.width;var F=Math.min(r,e.height-c*r);g.height=F;var h=g.getContext("2d");h.fillStyle="#ffffff",h.fillRect(0,0,g.width,g.height),h.drawImage(e,0,c*r,e.width,F,0,0,e.width,F);var m=g.toDataURL("image/png",1),x=n*(F/r);a.addImage(m,"PNG",0,0,o,x)}a.save(i||"certificate.pdf"),console.log("[FFC PDF] PDF saved:",i,"("+d+" page(s))"),console.log("[FFC PDF] === Complete ==="),p.remove(),t()}catch(e){console.error("[FFC PDF] Error:",e);var v="undefined"!=typeof ffc_ajax&&ffc_ajax.strings&&ffc_ajax.strings.errorGeneratingPdf?ffc_ajax.strings.errorGeneratingPdf:"Error generating PDF";alert(v),p.remove(),t()}}).catch(function(e){console.error("[FFC PDF] html2canvas error:",e);var a="undefined"!=typeof ffc_ajax&&ffc_ajax.strings&&ffc_ajax.strings.html2canvasFailed?ffc_ajax.strings.html2canvasFailed:"Error: html2canvas failed";alert(a),p.remove(),t()})},300)},o)}console.log("[FFC PDF] Waiting for "+u+" images to load..."),u>0?(x=setTimeout(function(){console.log("[FFC PDF] Timeout. Generating with "+P+"/"+u+" images."),C()},1e4),v.each(function(a){var o=this,t=e(o),n=t.attr("src");if(console.log("[FFC PDF] Image "+(a+1)+":",n?n.substring(0,80):"no src"),o.complete&&o.naturalHeight>0)console.log("[FFC PDF] Image "+(a+1)+" already loaded"),D();else if(t.one("load",function(){console.log("[FFC PDF] Image "+(a+1)+" loaded"),D()}),t.one("error",function(){console.warn("[FFC PDF] Image "+(a+1)+" failed:",n),D()}),n&&!n.startsWith("data:")){var i=o.src;o.src="",o.src=i}})):(console.log("[FFC PDF] No images, generating immediately"),C())}a.ffcGeneratePDF=n,a.ffcPdfGenerator={generatePDF:n,checkLibraries:o},console.log("[FFC PDF] PDF Generator module loaded (FIXED)")}(jQuery,window);